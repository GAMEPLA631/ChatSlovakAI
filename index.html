<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokročilý ChatSlovak AI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom scrollbar for a sleek look */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(45, 55, 72, 0.2);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.4);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.6);
        }

        /* Animated gradient overlay for an advanced feel */
        @keyframes subtle-gradient-anim {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            color: #1a202c; /* Default text color changed for better visibility on a light background */
            background-color: #f7fafc; /* Fallback farba */
            animation: subtle-gradient-anim 20s ease infinite; /* Aplikácia animácie */
        }

        /* Background container - will be filled with image via JS */
        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            z-index: -1; /* Ensure it's behind everything else */
        }

        /* Okná chatu sú teraz úplne priehľadné, aby bolo vidieť pozadie */
        .frosted-glass {
            background-color: rgba(0, 0, 0, 0);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .frosted-messages {
            background-color: rgba(0, 0, 0, 0);
        }
        
        /* Frosted glass pre vstupný riadok - teraz takmer priehľadný */
        .frosted-input {
            backdrop-filter: blur(0px); /* Úplne odstránený blur */
            -webkit-backdrop-filter: blur(0px);
            background-color: rgba(30, 41, 59, 0.1); /* Ešte nižšia priehľadnosť */
        }

        /* Chat bubbles with slightly lower opacity and text color change */
        .user-bubble {
            background-color: rgba(59, 130, 246, 0.6); /* Znížená priehľadnosť */
            color: #fff;
        }

        .ai-bubble {
            background-color: rgba(243, 244, 246, 0.8); /* Svetlejšia bublina */
            color: #1a202c; /* Tmavší text pre lepšiu čitateľnosť */
        }

        pre {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 0.75rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- New background container filled by JavaScript -->
    <div id="background-container"></div>

    <div class="w-full max-w-3xl flex flex-col items-center mb-8 text-white">
        <!-- Hello Message with a more dynamic feel -->
        <h2 class="text-4xl font-extrabold text-blue-300 drop-shadow-lg animate-pulse">Ahoj, Používateľ!</h2>
        <p class="text-xl text-gray-300 mt-2">Dnes tu pre teba mám nový, pokročilý chat.</p>
    </div>

    <!-- Main chat container with frosted glass effect -->
    <div class="frosted-glass rounded-[2rem] shadow-2xl overflow-hidden w-full max-w-3xl flex flex-col h-[75vh] md:h-[65vh] border-2 border-gray-700/60 transition-all duration-300 hover:shadow-glow">
        <!-- Chat Messages Area with its own frosted glass effect -->
        <div id="chat-messages" class="chat-messages flex-1 p-6 overflow-y-auto space-y-4 frosted-messages">
            <!-- Initial AI message -->
            <div class="flex justify-start">
                <div class="ai-bubble p-4 rounded-xl rounded-bl-none shadow-md max-w-[80%] transition-all duration-300 hover:shadow-lg">
                    <p>Ahoj! Vítam ťa v novej verzii ChatSlovak AI. Môžem ti pomôcť s generovaním textu, obrázkov, a teraz už aj s generovaním pokročilých 3D modelov pre hry ako Roblox. Ako ti dnes môžem pomôcť?</p>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center p-2 text-gray-400 text-sm">
            <i class="fas fa-spinner fa-spin mr-2"></i> ChatSlovak AI premýšľa...
        </div>

        <!-- Message Input and Buttons with frosted glass -->
        <div class="p-4 frosted-input border-t border-gray-600 flex items-center rounded-b-[2rem]">
            <div class="flex-1 flex items-center bg-gray-600/70 rounded-full p-2 shadow-inner transition-all duration-300 focus-within:bg-gray-500/80">
                <button class="text-gray-400 hover:text-gray-200 p-2 rounded-full transition duration-200">
                    <i class="fas fa-plus text-lg"></i>
                </button>
                <input
                    type="text"
                    id="user-input"
                    placeholder="Opýtaj sa ChatSlovak AI..."
                    class="flex-1 bg-transparent text-gray-200 placeholder-gray-400 focus:outline-none text-lg px-2"
                    onkeypress="handleKeyPress(event)"
                >
                <span class="text-gray-400 text-sm mr-2 opacity-70">Canvas</span>
            </div>
            <button
                id="send-button"
                class="ml-4 px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                onclick="sendMessage()"
                title="Odoslať správu"
            >
                <i class="fas fa-paper-plane"></i>
            </button>
            <button
                id="generate-image-button"
                class="ml-2 px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                onclick="generateImage()"
                title="Generovať obrázok"
            >
                <i class="fas fa-image"></i>
            </button>
            <button
                id="generate-3d-button"
                class="ml-2 px-4 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-full hover:from-green-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                onclick="generate3DModel()"
                title="Generovať 3D model"
            >
                <i class="fas fa-cube"></i>
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase configuration and initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Ensure __app_id and __firebase_config are defined
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Get references to input and buttons
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const generateImageButton = document.getElementById('generate-image-button');
        const generate3DButton = document.getElementById('generate-3d-button');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const loadingIndicator = document.getElementById('loading-indicator');
        const backgroundContainer = document.getElementById('background-container');

        // URL of the user's uploaded image
        const backgroundImageUrl = 'https://images.deepai.org/art-image/db646d2e02c148aa891e5d85b3dc1260/ai-a17914.jpg';

        // Initialize Firebase on window load
        window.onload = async function() {
            try {
                // Set the background image using JavaScript
                backgroundContainer.style.backgroundImage = `url('${backgroundImageUrl}')`;

                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in with custom token or anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    // Listen for auth state changes
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            console.log("User authenticated:", userId);
                            // Load previous messages after authentication
                            loadMessages();
                        } else {
                            userId = null;
                            isAuthReady = true;
                            console.log("No user authenticated. Signed in anonymously.");
                            // Load previous messages even if anonymous
                            loadMessages();
                        }
                    });
                } else {
                    console.error("Firebase configuration is missing.");
                    isAuthReady = true; // Allow app to run without Firestore if config is missing
                }
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                isAuthReady = true; // Allow app to run without Firestore if an error occurs
            }
        };

        /**
         * Function to speak text using Web Speech API.
         * Tries to find a Slovak voice, otherwise uses default.
         * @param {string} text The text to speak.
         */
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = window.speechSynthesis.getVoices();

                // Try to find a Slovak voice
                const slovakVoice = voices.find(voice => voice.lang.startsWith('sk'));
                if (slovakVoice) {
                    utterance.voice = slovakVoice;
                } else {
                    // Fallback to a suitable default if Slovak is not found
                    console.warn("Slovak voice not found, using default voice.");
                }

                window.speechSynthesis.speak(utterance);
            } else {
                console.warn("Web Speech API nie je podporované vo vašom prehliadači.");
            }
        }

        /**
         * Displays a message or an image in the chat window.
         * @param {string} content The text message or base64 image URL.
         * @param {string} sender 'user' or 'ai'.
         * @param {string} type 'text', 'image' or '3d_model'.
         */
        function displayMessage(content, sender, type = 'text') {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');

            const messageBubble = document.createElement('div');
            const senderClasses = sender === 'user'
                ? ['user-bubble', 'rounded-br-none']
                : ['ai-bubble', 'rounded-bl-none'];
            messageBubble.classList.add('p-4', 'rounded-xl', 'shadow-md', 'max-w-[80%]', ...senderClasses);

            if (type === 'text') {
                messageBubble.innerHTML = `<p>${content}</p>`;
            } else if (type === 'image') {
                messageBubble.innerHTML = `<img src="${content}" alt="Vygenerovaný obrázok" class="rounded-lg w-full h-auto object-contain">`;
            } else if (type === '3d_model') {
                try {
                    const modelData = JSON.parse(content);
                    messageBubble.innerHTML = `
                        <p class="font-bold text-lg">${modelData.modelName}</p>
                        <p class="mt-2 text-sm">${modelData.description}</p>
                        <p class="mt-4 font-semibold">Lua kód pre Roblox:</p>
                        <pre class="mt-2 text-xs overflow-auto"><code class="language-lua">${modelData.robloxLuaCode}</code></pre>
                        <p class="mt-2 text-xs text-gray-500">Skopíruj tento kód a vlož ho do skriptu v Roblox Studio.</p>
                    `;
                } catch (e) {
                    console.error("Failed to parse 3D model JSON:", e);
                    messageBubble.innerHTML = `<p>Nastala chyba pri spracovaní 3D modelu.</p>`;
                }
            }

            messageDiv.appendChild(messageBubble);
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
        }

        /**
         * Disables input and buttons to prevent multiple submissions.
         */
        function disableInputAndButtons() {
            userInput.disabled = true;
            sendButton.disabled = true;
            generateImageButton.disabled = true;
            generate3DButton.disabled = true;
            sendButton.classList.add('opacity-50', 'cursor-not-allowed');
            generateImageButton.classList.add('opacity-50', 'cursor-not-allowed');
            generate3DButton.classList.add('opacity-50', 'cursor-not-allowed');
        }

        /**
         * Enables input and buttons after a response.
         */
        function enableInputAndButtons() {
            userInput.disabled = false;
            sendButton.disabled = false;
            generateImageButton.disabled = false;
            generate3DButton.disabled = false;
            sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
            generateImageButton.classList.remove('opacity-50', 'cursor-not-allowed');
            generate3DButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        /**
         * Sends a text message to the AI and displays the response.
         */
        window.sendMessage = async function() {
            const message = userInput.value.trim();
            if (message === '') return;

            displayMessage(message, 'user', 'text');
            userInput.value = ''; // Clear input field

            loadingIndicator.classList.remove('hidden'); // Show loading indicator
            disableInputAndButtons(); // Disable input and buttons

            // Save user message to Firestore
            if (isAuthReady && db && userId) {
                try {
                    const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                    await setDoc(doc(messagesRef), {
                        text: message,
                        sender: 'user',
                        type: 'text', // Explicitly set type
                        timestamp: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error adding user message to Firestore: ", e);
                }
            }

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: "Odpovedaj vždy v slovenskom jazyku." }] });
                chatHistory.push({ role: "user", parts: [{ text: message }] });

                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyAzWkdCBiqlrFZODs2zEichlIWe68Wo2eI";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Response:", errorData);
                    let errorMessage = "Nastala chyba pri komunikácii s AI. Skús to prosím neskôr.";
                    if (errorData.error && errorData.error.message) {
                        errorMessage = `API chyba: ${errorData.error.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let aiResponseText = result.candidates[0].content.parts[0].text;
                    aiResponseText = aiResponseText.replace(/\*/g, '');
                    displayMessage(aiResponseText, 'ai', 'text');
                    speakText(aiResponseText);

                    if (isAuthReady && db && userId) {
                        try {
                            const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                            await setDoc(doc(messagesRef), {
                                text: aiResponseText,
                                sender: 'ai',
                                type: 'text',
                                timestamp: serverTimestamp()
                            });
                        } catch (e) {
                            console.error("Error adding AI message to Firestore: ", e);
                        }
                    }
                } else {
                    displayMessage("Prepáč, nedokázal som vygenerovať odpoveď. Skús to prosím znova.", 'ai', 'text');
                }
            } catch (error) {
                console.error("Error communicating with Gemini API:", error);
                displayMessage(error.message, 'ai', 'text');
            } finally {
                loadingIndicator.classList.add('hidden');
                enableInputAndButtons();
            }
        };

        /**
         * Generates an image based on the user's prompt and displays it.
         */
        window.generateImage = async function() {
            const prompt = userInput.value.trim();
            if (prompt === '') {
                displayMessage("Prosím, zadajte popis obrázka, ktorý chcete vygenerovať.", 'ai', 'text');
                return;
            }

            displayMessage(`Požiadavka na obrázok: "${prompt}"`, 'user', 'text');
            userInput.value = '';

            loadingIndicator.classList.remove('hidden');
            disableInputAndButtons();

            if (isAuthReady && db && userId) {
                try {
                    const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                    await setDoc(doc(messagesRef), {
                        text: `Požiadavka na obrázok: "${prompt}"`,
                        sender: 'user',
                        type: 'image_request',
                        timestamp: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error adding image request to Firestore: ", e);
                }
            }

            try {
                const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1 } };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Response:", errorData);
                    let errorMessage = "Nastala chyba pri generovaní obrázka. Skús to prosím neskôr.";
                    if (errorData.error && errorData.error.message) {
                        errorMessage = `API chyba: ${errorData.error.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    displayMessage(imageUrl, 'ai', 'image');

                    if (isAuthReady && db && userId) {
                        try {
                            const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                            await setDoc(doc(messagesRef), {
                                text: `Vygenerovaný obrázok pre: "${prompt}"`,
                                imageUrl: imageUrl,
                                sender: 'ai',
                                type: 'image_response',
                                timestamp: serverTimestamp()
                            });
                        } catch (e) {
                            console.error("Error adding AI image response to Firestore: ", e);
                        }
                    }
                } else {
                    displayMessage("Prepáč, nedokázal som vygenerovať obrázok. Skús to prosím znova s iným popisom.", 'ai', 'text');
                }
            } catch (error) {
                console.error("Error communicating with Image Generation API:", error);
                displayMessage(error.message, 'ai', 'text');
            } finally {
                loadingIndicator.classList.add('hidden');
                enableInputAndButtons();
            }
        };

        /**
         * Generates a structured 3D model response for Roblox.
         */
        window.generate3DModel = async function() {
            const prompt = userInput.value.trim();
            if (prompt === '') {
                displayMessage("Prosím, zadajte popis 3D modelu, ktorý chcete vytvoriť pre Roblox.", 'ai', 'text');
                return;
            }

            displayMessage(`Požiadavka na 3D model pre Roblox: "${prompt}"`, 'user', 'text');
            userInput.value = '';

            loadingIndicator.classList.remove('hidden');
            disableInputAndButtons();

            if (isAuthReady && db && userId) {
                try {
                    const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                    await setDoc(doc(messagesRef), {
                        text: `Požiadavka na 3D model pre Roblox: "${prompt}"`,
                        sender: 'user',
                        type: '3d_model_request',
                        timestamp: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error adding 3D model request to Firestore: ", e);
                }
            }

            try {
                // System instruction for generating structured Roblox data
                const systemPrompt = `Si špecializovaný asistent pre Roblox Studio. Tvoja úloha je generovať štruktúrované JSON objekty pre 3D modely. Pre každý model, vytvor objekt so "modelName" (názov modelu), "description" (krátky popis) a "robloxLuaCode" (Lua kód pre vytvorenie modelu v Roblox Studio). Tento kód by mal byť funkčný a používať základné primitívne diely a properties.`;
                const userQuery = `Vytvor Lua kód pre Roblox, ktorý vygeneruje 3D model na základe tohto popisu: ${prompt}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            "type": "OBJECT",
                            "properties": {
                                "modelName": { "type": "STRING", "description": "Názov 3D modelu." },
                                "description": { "type": "STRING", "description": "Krátky popis modelu." },
                                "robloxLuaCode": { "type": "STRING", "description": "Lua kód pre vytvorenie modelu v Roblox Studio." }
                            },
                            "required": ["modelName", "description", "robloxLuaCode"]
                        }
                    }
                };

                const apiKey = "AIzaSyAzWkdCBiqlrFZODs2zEichlIWe68Wo2eI";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Response:", errorData);
                    let errorMessage = "Nastala chyba pri generovaní 3D modelu. Skús to prosím neskôr.";
                    if (errorData.error && errorData.error.message) {
                        errorMessage = `API chyba: ${errorData.error.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let modelJson = result.candidates[0].content.parts[0].text;
                    
                    // Validate that the JSON is valid before passing it to displayMessage
                    try {
                        JSON.parse(modelJson);
                    } catch (e) {
                        console.error("Failed to parse AI response as JSON:", e);
                        displayMessage("Prepáč, formát odpovede AI bol neplatný. Skús to prosím znova.", 'ai', 'text');
                        return; // Stop execution if JSON is invalid
                    }

                    displayMessage(modelJson, 'ai', '3d_model');
                    // We typically don't speak code descriptions.

                    if (isAuthReady && db && userId) {
                        try {
                            const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                            await setDoc(doc(messagesRef), {
                                text: modelJson,
                                sender: 'ai',
                                type: '3d_model_response',
                                timestamp: serverTimestamp()
                            });
                        } catch (e) {
                            console.error("Error adding 3D model response to Firestore: ", e);
                        }
                    }
                } else {
                    displayMessage("Prepáč, nedokázal som vygenerovať 3D model. Skús to prosím znova s iným popisom.", 'ai', 'text');
                }
            } catch (error) {
                console.error("Error communicating with Gemini API for 3D model:", error);
                displayMessage(error.message, 'ai', 'text');
            } finally {
                loadingIndicator.classList.add('hidden');
                enableInputAndButtons();
            }
        };

        // Handle Enter key press
        window.handleKeyPress = function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        };

        // Function to load messages from Firestore
        function loadMessages() {
            if (db && userId && isAuthReady) {
                const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                const q = query(messagesRef);

                onSnapshot(q, (snapshot) => {
                    chatMessagesDiv.innerHTML = ''; // Clear current messages
                    const messages = [];
                    snapshot.forEach((doc) => {
                        messages.push(doc.data());
                    });

                    messages.sort((a, b) => {
                        const timestampA = a.timestamp ? a.timestamp.toMillis() : 0;
                        const timestampB = b.timestamp ? b.timestamp.toMillis() : 0;
                        return timestampA - timestampB;
                    });

                    messages.forEach((data) => {
                        if (data.type === 'image_response' && data.imageUrl) {
                            displayMessage(data.imageUrl, data.sender, 'image');
                        } else if (data.type === '3d_model_response') {
                            displayMessage(data.text, data.sender, '3d_model');
                        } else {
                            const cleanedText = data.text.replace(/\*/g, '');
                            displayMessage(cleanedText, data.sender, 'text');
                        }
                    });
                }, (error) => {
                    console.error("Error fetching messages from Firestore: ", error);
                });
            } else {
                console.log("Firestore is not ready or userId is not available to load messages.");
            }
        }
    </script>
</body>
</html>







