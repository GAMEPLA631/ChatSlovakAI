<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokročilý ChatSlovak AI s Pamäťou a Obrázkami</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom scrollbar for a sleek look */
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track { background: rgba(45, 55, 72, 0.2); border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(107, 114, 128, 0.4); border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.6); }

        /* Nová animácia pre jemné pulzovanie tieňa */
        @keyframes glow {
            0% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 30px rgba(34, 197, 94, 0.4); }
            100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
        }

        body {
            font-family: 'Inter', sans-serif;
            color: #1a202c;
            background-color: #0d1a29; /* Statická tmavomodrá farba pozadia */
        }

        /* Background container - will be filled with image via JS */
        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            z-index: -1;
        }

        /* Okná chatu sú teraz úplne priehľadné, aby bolo vidieť pozadie */
        .frosted-glass {
            background-color: rgba(0, 0, 0, 0);
            border-color: rgba(255, 255, 255, 0.1);
            animation: glow 4s ease infinite; /* Aplikácia novej animácie */
        }
        .frosted-messages {
            background-color: rgba(0, 0, 0, 0);
        }
        
        /* Frosted glass pre vstupný riadok - teraz takmer priehľadný */
        .frosted-input {
            backdrop-filter: blur(0px);
            -webkit-backdrop-filter: blur(0px);
            background-color: rgba(30, 41, 59, 0.1);
        }

        /* Chat bubbles with slightly lower opacity and text color change */
        .user-bubble {
            background-color: rgba(59, 130, 246, 0.6);
            color: #fff;
        }

        .ai-bubble {
            background-color: rgba(243, 244, 246, 0.8);
            color: #1a202c;
        }

        /* Image preview styling */
        .image-preview-container {
            border: 2px dashed #60a5fa;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- New background container filled by JavaScript -->
    <div id="background-container"></div>

    <div class="w-full max-w-3xl flex flex-col items-center mb-8 text-white">
        <!-- Hello Message with a more dynamic feel -->
        <h2 class="text-4xl font-extrabold text-blue-300 drop-shadow-lg">Ahoj, Používateľ!</h2>
        <p class="text-xl text-gray-300 mt-2">Pokročilý chat s pamäťou, podporou obrázkov a hlasovou odozvou.</p>
    </div>

    <!-- Main chat container with frosted glass effect -->
    <div class="frosted-glass rounded-[2rem] shadow-2xl overflow-hidden w-full max-w-3xl flex flex-col h-[75vh] md:h-[65vh] border-2 border-gray-700/60 transition-all duration-300 hover:shadow-glow">
        <!-- Chat Messages Area with its own frosted glass effect -->
        <div id="chat-messages" class="chat-messages flex-1 p-6 overflow-y-auto space-y-4 frosted-messages">
            <!-- Initial AI message -->
            <div class="flex justify-start">
                <div class="ai-bubble p-4 rounded-xl rounded-bl-none shadow-md max-w-[80%] transition-all duration-300 hover:shadow-lg">
                    <div class="flex items-start justify-between space-x-3">
                        <p>Ahoj! Vítam ťa v novej verzii ChatSlovak AI. Pamätám si, o čom sa bavíme, a teraz môžem analyzovať aj obrázky, ktoré nahráš. Tiež ti môžem všetky svoje odpovede prečítať. Ako ti dnes môžem pomôcť?</p>
                        <button onclick="speakResponse('Ahoj! Vítam ťa v novej verzii ChatSlovak AI. Pamätám si, o čom sa bavíme, a teraz môžem analyzovať aj obrázky, ktoré nahráš. Tiež ti môžem všetky svoje odpovede prečítať. Ako ti dnes môžem pomôcť?', this)" 
                                class="flex-shrink-0 text-gray-600 hover:text-blue-700 p-1 transition duration-200 ml-3" 
                                title="Prehrať znova">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center p-2 text-gray-400 text-sm">
            <!-- Dynamický text sa nastaví v JS -->
            <i class="fas fa-spinner fa-spin mr-2"></i> <span id="loading-text">Premýšľam...</span>
        </div>

        <!-- Image Preview Area -->
        <div id="image-preview" class="hidden p-2 mx-4 mt-2 image-preview-container">
            <span class="truncate">Obrázok pripravený na odoslanie: <span id="image-filename"></span></span>
            <button onclick="clearImage()" class="ml-4 text-red-400 hover:text-red-300 transition duration-200" title="Odstrániť obrázok">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Message Input and Buttons with frosted glass -->
        <div class="p-4 frosted-input border-t border-gray-600 flex items-center rounded-b-[2rem]">
            <div class="flex-1 flex items-center bg-gray-600/70 rounded-full p-2 shadow-inner transition-all duration-300 focus-within:bg-gray-500/80">
                <!-- Image Upload Button -->
                <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="previewImage(event)">
                <button
                    onclick="document.getElementById('image-upload').click()"
                    class="text-gray-400 hover:text-green-400 p-2 rounded-full transition duration-200"
                    title="Nahrať obrázok"
                >
                    <i class="fas fa-image text-lg"></i>
                </button>

                <input
                    type="text"
                    id="user-input"
                    placeholder="Opýtaj sa ChatSlovak AI..."
                    class="flex-1 bg-transparent text-gray-200 placeholder-gray-400 focus:outline-none text-lg px-2"
                    onkeypress="handleKeyPress(event)"
                >
                <span class="text-gray-400 text-sm mr-2 opacity-70">Canvas</span>
            </div>
            <button
                id="send-button"
                class="ml-4 px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                onclick="sendMessage()"
                title="Odoslať správu"
            >
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase configuration and initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase, Auth, and Chat History
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let chatHistory = []; // Pole pre pamäť konverzácie (pre API)
        let selectedImage = null; // Base64 kód obrázka
        let selectedImageMimeType = null;
        let currentAudio = null; // Pre zastavenie predchádzajúceho prehrávania

        const systemInstruction = {
            parts: [{
                text: "Pôsob ako priateľský a znalý asistent. Odpovedaj výhradne v slovenskom jazyku. Tvojou hlavnou úlohou je analyzovať textové otázky a vizuálny obsah (obrázky). NEPOUŽÍVAJ žiadne špeciálne znaky formátovania ako **hviezdicky**, __podčiarkovníky__, *kurzívu* alebo mriežky (#, ##, ###) v tvojich odpovediach. Odpovedaj čisto textovo, bez ohľadu na to, či ide o text alebo analýzu obrázku. Tvoje odpovede musia byť prirodzené a priamočiare."
            }]
        };

        // Ensure __app_id and __firebase_config are defined
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Get references to input and buttons
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        const backgroundContainer = document.getElementById('background-container');
        const imagePreviewDiv = document.getElementById('image-preview');
        const imageFilenameSpan = document.getElementById('image-filename');
        const imageUploadInput = document.getElementById('image-upload');

        // URL of the user's uploaded image for background (using a placeholder)
        const backgroundImageUrl = 'https://images.deepai.org/art-image/db646d2e02c148aa891e5d85b3dc1260/ai-a17914.jpg';

        // Initialize Firebase on window load
        window.onload = async function() {
            try {
                // Set the background image using JavaScript
                backgroundContainer.style.backgroundImage = `url('${backgroundImageUrl}')`;

                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            console.log("User authenticated:", userId);
                            loadMessages();
                        } else {
                            userId = crypto.randomUUID(); // Use random ID for anonymous
                            isAuthReady = true;
                            console.log("No user authenticated. Signed in anonymously.");
                            loadMessages();
                        }
                    });
                } else {
                    console.error("Firebase configuration is missing.");
                    isAuthReady = true;
                }
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                isAuthReady = true;
            }
        };

        /**
         * Clears the selected image state.
         */
        window.clearImage = function() {
            selectedImage = null;
            selectedImageMimeType = null;
            imageUploadInput.value = ''; // Reset file input
            imagePreviewDiv.classList.add('hidden');
            imageFilenameSpan.textContent = '';
        };
        
        /**
         * Previews the selected image and stores its Base64 data.
         */
        window.previewImage = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImage = e.target.result.split(',')[1]; // Base64 data
                    selectedImageMimeType = file.type;
                    imageFilenameSpan.textContent = file.name;
                    imagePreviewDiv.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                clearImage();
            }
        };

        /**
         * Displays a message or an image in the chat window.
         * @param {string} content The text message or Base64 image URL.
         * @param {string} sender 'user' or 'ai'.
         * @param {string} type 'text' or 'image_upload'.
         * @param {string} mimeType MIME type for image.
         */
        function displayMessage(content, sender, type = 'text', mimeType = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');

            const messageBubble = document.createElement('div');
            const senderClasses = sender === 'user'
                ? ['user-bubble', 'rounded-br-none']
                : ['ai-bubble', 'rounded-bl-none'];
            messageBubble.classList.add('p-4', 'rounded-xl', 'shadow-md', 'max-w-[80%]', ...senderClasses, 'transition-all', 'duration-300', 'hover:shadow-lg');

            if (type === 'text') {
                // Ensure text is clean from any remaining markdown characters
                const cleanedText = content.replace(/###/g, '').replace(/\*/g, '');
                
                if (sender === 'ai') {
                    const aiBubbleContent = document.createElement('div');
                    aiBubbleContent.classList.add('flex', 'items-start', 'justify-between', 'space-x-3');
                    
                    const textP = document.createElement('p');
                    textP.textContent = cleanedText;

                    const speakerButton = document.createElement('button');
                    speakerButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    speakerButton.classList.add('flex-shrink-0', 'text-gray-600', 'hover:text-blue-700', 'p-1', 'transition', 'duration-200', 'ml-3');
                    speakerButton.onclick = () => speakResponse(cleanedText, speakerButton);
                    speakerButton.title = "Prečítať odpoveď";
                    speakerButton.setAttribute('data-speaking', 'false'); // Custom state attribute

                    aiBubbleContent.appendChild(textP);
                    aiBubbleContent.appendChild(speakerButton);
                    messageBubble.appendChild(aiBubbleContent);

                } else {
                    messageBubble.innerHTML = `<p>${cleanedText}</p>`;
                }
            } else if (type === 'image_upload' && mimeType) {
                const imageUrl = `data:${mimeType};base64,${content}`;
                messageBubble.innerHTML = `
                    <p class="font-semibold mb-2">Nahratý obrázok:</p>
                    <img src="${imageUrl}" class="rounded-lg max-h-48 w-auto object-contain shadow-md" alt="Nahratý obrázok" />
                `;
            }

            messageDiv.appendChild(messageBubble);
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
            
            // Return the speaker button for direct manipulation if needed
            if (sender === 'ai' && type === 'text') {
                return messageBubble.querySelector('button');
            }
            return null;
        }

        /**
         * Disables input and buttons to prevent multiple submissions.
         */
        function disableInputAndButtons(isImage = false) {
            userInput.disabled = true;
            sendButton.disabled = true;
            sendButton.classList.add('opacity-50', 'cursor-not-allowed');
            loadingIndicator.classList.remove('hidden');
            loadingText.textContent = isImage ? 'Počkaj Chvíľu Pozeram obrazok' : 'Premýšľam...';
        }

        /**
         * Enables input and buttons after a response.
         */
        function enableInputAndButtons() {
            userInput.disabled = false;
            sendButton.disabled = false;
            sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
            loadingIndicator.classList.add('hidden');
            loadingText.textContent = 'Premýšľam...'; // Reset default
        }

        // --- TTS Utility Functions ---
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate = 24000) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const numFrames = pcm16.length;
            const dataSize = numFrames * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // Write RIFF header
            view.setUint32(0, 0x46464952, false); // "RIFF"
            view.setUint32(4, 36 + dataSize, true); // File size - 8
            view.setUint32(8, 0x45564157, false); // "WAVE"

            // Write FMT sub-chunk
            view.setUint32(12, 0x20746d66, false); // "fmt "
            view.setUint32(16, 16, true); // Sub-chunk size (16 for PCM)
            view.setUint16(20, 1, true); // Audio Format (1 = PCM)
            view.setUint16(22, numChannels, true); // Number of channels
            view.setUint32(24, sampleRate, true); // Sample rate
            view.setUint32(28, byteRate, true); // Byte rate
            view.setUint16(32, blockAlign, true); // Block align
            view.setUint16(34, bytesPerSample * 8, true); // Bits per sample (16)

            // Write DATA sub-chunk
            view.setUint32(36, 0x61746164, false); // "data"
            view.setUint32(40, dataSize, true); // Data size

            // Write PCM data
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        function playAudio(wavBlob, speakerButton = null) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.removeAttribute('src'); // Clean up old blob
            }

            const audioUrl = URL.createObjectURL(wavBlob);
            const audio = new Audio(audioUrl);
            currentAudio = audio;

            if (speakerButton) {
                speakerButton.innerHTML = '<i class="fas fa-volume-up fa-spin"></i>'; // Indicate playing
                speakerButton.setAttribute('data-speaking', 'true');
            }

            audio.onended = () => {
                if (speakerButton) {
                    speakerButton.innerHTML = '<i class="fas fa-volume-up"></i>'; // Reset icon
                    speakerButton.setAttribute('data-speaking', 'false');
                }
                URL.revokeObjectURL(audioUrl);
                if (currentAudio === audio) currentAudio = null;
            };

            audio.onerror = (e) => {
                console.error("Audio playback error:", e);
                if (speakerButton) {
                    speakerButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    speakerButton.setAttribute('data-speaking', 'false');
                }
            };

            audio.play().catch(e => console.error("Error playing audio:", e));
        }

        /**
         * Converts text to speech using the Gemini API and plays it.
         * @param {string} text The text to be spoken.
         * @param {HTMLElement | null} speakerButton The button element to update (optional).
         */
        window.speakResponse = async function(text, speakerButton = null) {
            // If the same audio is already speaking, stop it.
            if (speakerButton && speakerButton.getAttribute('data-speaking') === 'true') {
                 if (currentAudio) currentAudio.pause();
                 return;
            }

            try {
                if (speakerButton) {
                    speakerButton.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>'; // Loading icon
                    speakerButton.disabled = true;
                }
                
                const payload = {
                    contents: [{
                        parts: [{ 
                            // Add instruction for Slovak pronunciation
                            text: `Prečítaj nasledujúci text v slovenskej výslovnosti a priateľským tónom: "${text}"`
                        }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                // Kore has a firm, clear tone.
                                prebuiltVoiceConfig: { voiceName: "Kore" } 
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error("TTS API hov zlyhal: " + response.statusText);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    // API returns signed PCM16 audio data.
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    playAudio(wavBlob, speakerButton);
                } else {
                    throw new Error("Neplatná audio odpoveď z API.");
                }

            } catch (error) {
                console.error("Chyba pri generovaní hlasu:", error);
                if (speakerButton) {
                    speakerButton.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
                    speakerButton.title = "Chyba pri prehrávaní";
                }
                setTimeout(() => {
                    if (speakerButton) {
                        speakerButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                        speakerButton.title = "Prečítať odpoveď";
                        speakerButton.disabled = false;
                    }
                }, 2000); // Reset after 2 seconds
            } finally {
                if (speakerButton && speakerButton.getAttribute('data-speaking') !== 'true') {
                    speakerButton.disabled = false;
                }
            }
        }
        // --- End TTS Utility Functions ---

        /**
         * Sends a text or multimodal message to the AI and displays the response.
         */
        window.sendMessage = async function() {
            const message = userInput.value.trim();
            const hasImage = selectedImage !== null;

            if (message === '' && !hasImage) return;

            // 1. Prepare message parts for display and API payload
            const userParts = [];
            let displayContent = message;

            if (hasImage) {
                // Display the image first
                displayMessage(selectedImage, 'user', 'image_upload', selectedImageMimeType);
                // Add the image to the user's part for the API
                userParts.push({
                    inlineData: {
                        mimeType: selectedImageMimeType,
                        data: selectedImage
                    }
                });
            }

            if (message !== '') {
                displayMessage(message, 'user', 'text');
                userParts.push({ text: message });
            }

            // 2. Add the user's full message part to the session history
            chatHistory.push({ role: "user", parts: userParts });

            // 3. Update UI
            userInput.value = '';
            clearImage(); // Clear image state after sending
            disableInputAndButtons(hasImage);

            // 4. Save user message to Firestore (for cross-session persistence)
            if (isAuthReady && db && userId) {
                try {
                    const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                    await setDoc(doc(messagesRef), {
                        text: displayContent,
                        sender: 'user',
                        type: hasImage ? 'multimodal' : 'text',
                        imageData: hasImage ? selectedImage : null,
                        imageMimeType: hasImage ? selectedImageMimeType : null,
                        timestamp: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error adding user message to Firestore: ", e);
                }
            }

            // 5. Construct API payload with history and system instruction
            try {
                // The contents should be the full chat history
                const payload = {
                    contents: chatHistory,
                    systemInstruction: systemInstruction,
                };
                
                const apiKey = "AIzaSyAzWkdCBiqlrFZODs2zEichlIWe68Wo2eI"; // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = "Nastala chyba pri komunikácii s AI. Skús to prosím neskôr.";
                    if (errorData.error && errorData.error.message) {
                        errorMessage = `API chyba: ${errorData.error.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    let aiResponseText = result.candidates[0].content.parts[0].text;
                    
                    // Enforce clean text structure (safety measure against model deviation)
                    aiResponseText = aiResponseText.replace(/###/g, '').replace(/\*/g, '').trim(); 
                    
                    const speakerButton = displayMessage(aiResponseText, 'ai', 'text');
                    
                    // Add AI response to the session history
                    chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

                    // AUTOMATIC TTS PLAYBACK
                    if (speakerButton) {
                        speakResponse(aiResponseText, speakerButton);
                    }

                    if (isAuthReady && db && userId) {
                        try {
                            const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                            await setDoc(doc(messagesRef), {
                                text: aiResponseText,
                                sender: 'ai',
                                type: 'text',
                                timestamp: serverTimestamp()
                            });
                        } catch (e) {
                            console.error("Error adding AI message to Firestore: ", e);
                        }
                    }
                } else {
                    displayMessage("Prepáč, nedokázal som vygenerovať odpoveď. Skús to prosím znova.", 'ai', 'text');
                }
            } catch (error) {
                console.error("Error communicating with Gemini API:", error);
                const errorMessage = error.message || "Nečakaná chyba komunikácie.";
                chatHistory.push({ role: "model", parts: [{ text: errorMessage }] });
                displayMessage(errorMessage, 'ai', 'text');
            } finally {
                enableInputAndButtons();
            }
        };

        // Handle Enter key press
        window.handleKeyPress = function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        };

        // Function to load messages from Firestore
        function loadMessages() {
            if (db && isAuthReady) {
                // Initialize chat history with the system instruction
                chatHistory = [systemInstruction];

                if (userId) {
                    const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                    const q = query(messagesRef);

                    onSnapshot(q, (snapshot) => {
                        chatMessagesDiv.innerHTML = ''; // Clear current messages
                        const messages = [];
                        snapshot.forEach((doc) => {
                            messages.push({ id: doc.id, ...doc.data() });
                        });

                        messages.sort((a, b) => {
                            const timestampA = a.timestamp ? a.timestamp.toMillis() : 0;
                            const timestampB = b.timestamp ? b.timestamp.toMillis() : 0;
                            return timestampA - timestampB;
                        });

                        // Start with initial AI greeting
                        const initialGreeting = "Ahoj! Vítam ťa v novej verzii ChatSlovak AI. Pamätám si, o čom sa bavíme, a teraz môžem analyzovať aj obrázky, ktoré nahráš. Tiež ti môžem všetky svoje odpovede prečítať. Ako ti dnes môžem pomôcť?";
                        
                        // Manually create the initial greeting with the speaker button
                        const initialMessageDiv = document.createElement('div');
                        initialMessageDiv.classList.add('flex', 'justify-start');
                        initialMessageDiv.innerHTML = `
                            <div class="ai-bubble p-4 rounded-xl rounded-bl-none shadow-md max-w-[80%] transition-all duration-300 hover:shadow-lg">
                                <div class="flex items-start justify-between space-x-3">
                                    <p>${initialGreeting}</p>
                                    <button onclick="speakResponse('${initialGreeting.replace(/'/g, "\\'")}', this)" 
                                            class="flex-shrink-0 text-gray-600 hover:text-blue-700 p-1 transition duration-200 ml-3" 
                                            title="Prehrať znova">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        chatMessagesDiv.appendChild(initialMessageDiv);


                        // Rebuild chat history for session memory (excluding system instruction for this loop)
                        chatHistory = [systemInstruction];

                        messages.forEach((data) => {
                            // Clean text from any markdown before displaying
                            const cleanedText = (data.text || '').replace(/###/g, '').replace(/\*/g, '');
                            
                            if (data.sender === 'user' && data.type === 'multimodal' && data.imageData && data.imageMimeType) {
                                // Rebuild multimodal message for UI
                                displayMessage(data.imageData, 'user', 'image_upload', data.imageMimeType);
                                if (cleanedText) {
                                     // Display accompanying text
                                    displayMessage(cleanedText, 'user', 'text');
                                }
                                
                                // Rebuild multimodal message for API memory
                                const userParts = [];
                                userParts.push({ inlineData: { mimeType: data.imageMimeType, data: data.imageData } });
                                if (cleanedText) { userParts.push({ text: cleanedText }); }
                                chatHistory.push({ role: "user", parts: userParts });

                            } else {
                                // Display standard text message (displayMessage handles AI speaker button)
                                displayMessage(cleanedText, data.sender, 'text');
                                
                                // Rebuild standard text message for API memory
                                const role = data.sender === 'user' ? 'user' : 'model';
                                chatHistory.push({ role: role, parts: [{ text: cleanedText }] });
                            }
                        });

                        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom

                    }, (error) => {
                        console.error("Error fetching messages from Firestore: ", error);
                    });
                } else {
                     // If no user ID yet (though it should be assigned anonymously), initialize history
                    chatHistory = [systemInstruction];
                }
            } else {
                console.log("Firestore is not ready or userId is not available to load messages.");
            }
        }
    </script>
</body>
</html>





